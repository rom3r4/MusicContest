#!/usr/bin/env ruby
require 'fileutils'
include FileUtils

# path to your application root.
APP_ROOT = File.expand_path('..', __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file.
  puts '== Checking Environment variables =='
  env_variable_error = false

  if ENV['DB_NAME'].nil?
    puts "- The environment variable 'DB_NAME' is not defined"
    puts "  run:"
    puts "      export DB_NAME=your_database_name\n\n"
    env_variable_error = true
  end
  if ENV['DB_USER'].nil?
    puts "- The environment variable 'DB_USER' is not defined"
    puts "  run:"
    puts "      export DB_USER=your_database_username\n\n"
    env_variable_error = true
  end
  if ENV['DB_PASS'].nil?
    puts "- The environment variable 'DB_PASS' is not defined"
    puts "  run:"
    puts "      export DB_PASS=your_database_passwd\n\n"
    env_variable_error = true
  end
  if ENV['SPOTIFY_CLIENT_SECRET'].nil?
    puts "- The environment variable 'SPOTIFY_CLIENT_SECRET' is not defined"
    puts "  run:"
    puts "      export SPOTIFY_CLIENT_SECRET=your_spotify_secret\n\n"
    env_variable_error = true
  end
  if ENV['SPOTIFY_CLIENT_ID'].nil?
    puts "- The environment variable 'SPOTIFY_CLIENT_ID' is not defined"
    puts "  run:"
    puts "      export SPOTIFY_CLIENT_ID=your_spotify_id\n\n"
    env_variable_error = true
  end

  if env_variable_error
    exit 1
  end

  puts "\n== Installing dependencies =="
  system! 'gem install bundler --conservative'
  system('bundle check') || system!('bundle install')

  # puts "\n== Copying sample files =="
  # unless File.exist?('config/database.yml')
  #   cp 'config/database.yml.sample', 'config/database.yml'
  # end
  
  puts "\n== Preparing database =="
  system! 'bin/rails db:setup'
  
  puts "\n== Removing old logs and tempfiles =="
  system! 'bin/rails log:clear tmp:clear'

  puts "\n== Restarting application server =="
  system! 'bin/rails restart'

  puts "\n== Running Rspec tests =="
  system 'bundle exec rake spec'

  puts "\n== Running Rubocop tests =="
  system 'bundle exec rubocop'

end
